<!DOCTYPE html>
<html>
<head>
    <title>Commit Bubbles</title>
		<link href="http://nvd3.org//assets/css/nv.d3.css" rel="stylesheet">
		<script src="http://nvd3.org/assets/lib/d3.v3.js"></script>
		<script src="http://nvd3.org/assets/js/nv.d3.js"></script>
		<script src="http://underscorejs.org/underscore-min.js"></script>
    <script>
            ALL_COMMITS = [
              {author: "John Doe", commits:  [{
                time: 100,
                hash: "1234567890",
                testPercentage: 100,
                size: 44,
              },
							{
                time: 200,
                hash: "1234567890",
                testPercentage: 90,
                size: 84,
              }]},
              {author: "Nancy", commits:  [{
                time: 150,
                hash: "1234567890",
                testPercentage: 50,
                size: 244,
              },
							{
                time: 300,
                hash: "1234567890",
                testPercentage: 10,
                size: 144,
              }]},
              {author: "Mildred", commits: [{
                time: 455,
                hash: "1234567890",
                testPercentage: 15,
                size: 22,
              }]}];
    </script>
</head>
<body bgcolor="#FFFFFF">
  <div id="graph"><svg style="height: 600px; width: 600px"></svg></div>
</body>

<script>
nv.addGraph(function() {
  findLastCommitTime = function(all_commits) {
    return _.chain(ALL_COMMITS)
            .pluck('commits')
            .flatten()
            .pluck('time')
            .max().value();
  };

  var data = transformData(ALL_COMMITS);
  var chart = nv.models.scatterChart()
                .color(d3.scale.category10().range());
  chart.xAxis.axisLabel('Time');
  chart.tooltipContent(function(key) {
      return '<h3>' + key + '</h3>';
  });
  chart.forceX([0, findLastCommitTime(ALL_COMMITS)]);
  chart.forceY([0, 100]);

  chart.margin({left: 110, top: 30});

  d3.select('#graph svg')
      .datum(data)
      .call(chart);

  var addExtraXAxisLabel = function (svg) { 
    return svg.append("text")
      .style("font-size", 18)
      .attr('x', 12);
  };
  addExtraXAxisLabel(d3.select('#graph svg'))
      .text("All test")
      .attr('y', 34);

  addExtraXAxisLabel(d3.select('#graph svg'))
      .text("All prod")
      .attr('y', 553);

  return chart;
});

function transformData(all_commits) {
  return _(all_commits)
    .map(function (commits_by_author) {
      var values = _(commits_by_author.commits).map(
        function (commit) {
          return { x: commit.time, y: commit.testPercentage, size: commit.size };
        });
      return {key: commits_by_author.author, values: values};
     });
}
</script>
</html>
